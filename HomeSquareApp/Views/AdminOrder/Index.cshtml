@model IEnumerable<HomeSquareApp.Models.Order>

@{
    ViewData["Title"] = "Order List";
    Layout = "_AdminLayout";
    ViewData["NavData"] = "Order";
    ViewData["CurrentPage"] = "Main";
}

@section pageSpecificCss{
    <style>
        .modal-confirm {
            color: #636363;
        }

            .modal-confirm .modal-content {
                margin-top:30px;
                padding: 20px;
                border-radius: 5px;
                border: none;
                text-align: center;
                font-size: 16px;
            }

            .modal-confirm .modal-header {
                border-bottom: none;
                position: relative;
            }

            .modal-confirm h4 {
                text-align: center;
                font-size: 26px;
                margin: 20px 0 -10px;
            }

            .modal-confirm .close {
                position: absolute;
                top: -5px;
                right: -2px;
            }

            .modal-confirm .modal-body {
                color: #999;
            }

            .modal-confirm .modal-footer {
                border: none;
                text-align: center;
                border-radius: 5px;
                font-size: 13px;
                padding: 10px 15px 25px;
            }

                .modal-confirm .modal-footer a {
                    color: #999;
                }

            .modal-confirm .btn, .modal-confirm .btn:active {
                color: #fff;
                border-radius: 4px;
                background: #60c7c1;
                text-decoration: none;
                transition: all 0.4s;
                line-height: normal;
                min-width: 120px;
                border: none;
                min-height: 40px;
                border-radius: 3px;
                margin: 0 5px;
            }

            .modal-confirm .btn-secondary {
                background: #c1c1c1;
            }

                .modal-confirm .btn-secondary:hover, .modal-confirm .btn-secondary:focus {
                    background: #a8a8a8;
                }

            .modal-confirm .btn-danger {
                background: #f15e5e;
            }

                .modal-confirm .btn-danger:hover, .modal-confirm .btn-danger:focus {
                    background: #ee3535;
                }

        .trigger-btn {
            display: inline-block;
            margin: 100px auto;
        }
    </style>
}

<div id="vueEl" class="mb-2">
    <div class="d-md-flex justify-content-center">
        <div class="col-md-4 col-9 mb-2">
            <div class="input-group">

                <input type="text" class="form-control" v-model="searchValue" :placeholder="[[ searchPlaceholder ]]">

                @* NYD Update the Categories based on clicked option *@
                <button v-text="categorySelected.name" class="btn btn-sm border-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false"></button>
                <ul style="z-index:4" class="dropdown-menu dropdown-menu-end">
                    <li v-for="item in categoryItems">
                        <button @@click="changeCategory(item.id)" class="dropdown-item">{{item.name}}</button>
                    </li>
                </ul>
            </div>
        </div>
        <span class="ms-md-2">
            <button class="btn btn-outline-dark rounded-0" type="button" @@click="generateFilterResult()">
                Filter Result
            </button>
        </span>
    </div>
    <div class="container-fluid">
        <div class="row row-cols-auto justify-content-md-center justify-content-start gap-2 py-4">
            <div v-for="filterItem in filters" class="col">
                <filter-badge @@delete-filter="deleteFilter" :filter="filterItem"></filter-badge>
            </div>
        </div>
    </div>
</div>


<div id="orderTable">
    <div class="table-responsive" style="min-height:440px">
        <table class="table">
            <thead>
                <tr>
                    <th onclick="sortData('orderDate')">
                        <a class="d-flex align-items-end tableSortLink">
                            <i class="fas fa-sort d-flex align-items-start me-1" style="width:16px;height:20px"></i>
                            @Html.DisplayNameFor(model => model.OrderDateTime)
                        </a>
                    </th>
                    <th onclick="sortData('firstName')">
                        <a class="d-flex align-items-end tableSortLink">
                            <i class="fas fa-sort d-flex align-items-start me-1" style="width:16px;height:20px"></i>
                            @Html.DisplayNameFor(model => model.User.FirstName)
                        </a>
                    </th>
                    <th onclick="sortData('lastName')">
                        <a class="d-flex align-items-end tableSortLink">
                            <i class="fas fa-sort d-flex align-items-start me-1" style="width:16px;height:20px"></i>
                            @Html.DisplayNameFor(model => model.User.LastName)
                        </a>
                    </th>
                    <th onclick="sortData('orderStatus')">
                        <a class="d-flex align-items-end tableSortLink">
                            <i class="fas fa-sort d-flex align-items-start me-1" style="width:16px;height:20px"></i>
                            @Html.DisplayNameFor(model => model.OrderStatus)
                        </a>
                    </th>
                    <th onclick="sortData('deliveryOption')">
                        <a class="d-flex align-items-end tableSortLink">
                            <i class="fas fa-sort d-flex align-items-start me-1" style="width:16px;height:20px"></i>
                            @Html.DisplayNameFor(model => model.DeliveryOptions)
                        </a>
                    </th>
                    <th>
                        @*Actions*@
                    </th>
                </tr>
            </thead>
            <tbody id="tableData">
                <partial name="_AdminOrderTableDataPartial" model="Model" />
            </tbody>
        </table>
    </div>
    <div class="d-flex" id="pagination">
        <partial name="_PaginationPartial" />
    </div>
</div>

<!-- Modal -->
<div class="modal fade" id="deleteConfirmationModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-confirm">
        <div class="modal-content">
            <div class="modal-header flex-column">
                <i class="far fa-times-circle fa-5x text-danger"></i>
                <h4 class="modal-title w-100">Are you sure?</h4>
                <button type="button" class="btn-close close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Do you really want to delete these records? This process cannot be undone.</p>
            </div>
            <div class="modal-footer justify-content-center">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="deleteConfirmed()">Delete</button>
            </div>
        </div>
    </div>
</div>

@section Scripts{

    <script>
        var paginationList = document.getElementsByClassName("paginationElement")
        var currentPage = 0;
        function goToPage(pageNumber) {
            //set style
            updatePaginationStyle(pageNumber)
            currentPage = pageNumber;


            $.ajax(
                {
                    type: "POST", //HTTP POST Method
                    url: "/AdminOrder/OrderNextTableData", // Controller/View
                    data: {
                        pageNumber: pageNumber
                    }
                }).done(function (data) {
                    
                    $("#tableData").html(data)
                });
        }

        function updatePaginationStyle(pageNumber) {
            var prevPageBtn = document.getElementById("prevPageBtn");
            if (prevPageBtn != null) {
                if ( pageNumber != 0) {
                    prevPageBtn.hidden = false;
                } else {
                    prevPageBtn.hidden = true;
                }
            }

            var nextPageBtn = document.getElementById('nextPageBtn');
            if (nextPageBtn != null) {
                if (pageNumber == paginationList.length - 1) {
                    nextPageBtn.hidden = true;
                } else {
                    nextPageBtn.hidden = false;
                }
            }

            for (i = 0; i < paginationList.length; i++) {
                paginationList[i].classList.remove("active");
                if (i == pageNumber) {
                    paginationList[i].classList.add("active");
                }
                //hide button that are not in range of this
                if (i >= pageNumber - 1 && i < pageNumber + 3) {
                    paginationList[i].hidden = false

                } else {
                    paginationList[i].hidden = true
                }
            }
        }

    @* Sorting Function *@
        //set to true if desc comes first
        var orderDateToggle = false;
        var firstNameToggle = true;
        var lastNameToggle = true;
        var orderStatusToggle = false;
        var deliveryOptionToggle = true;

        function sortData(sortOrder) {
            if (sortOrder == "orderDate") {
                sortOrder += orderDateToggle ? "_desc" : "_asc"
                orderDateToggle = !orderDateToggle
            } else if (sortOrder == "firstName") {
                sortOrder += firstNameToggle ? "_desc" : "_asc"
                firstNameToggle = !firstNameToggle
            } else if (sortOrder == "lastName") {
                sortOrder += lastNameToggle ? "_desc" : "_asc"
                lastNameToggle = !lastNameToggle
            } else if (sortOrder == "orderStatus") {
                sortOrder += orderStatusToggle ? "_desc" : "_asc"
                orderStatusToggle = !orderStatusToggle
            }
            else if (sortOrder == "deliveryOption") {
                sortOrder += deliveryOptionToggle ? "_desc" : "_asc"
                deliveryOptionToggle = !deliveryOptionToggle
            }


            $.ajax(
                {
                    type: "POST", //HTTP POST Method
                    url: "/AdminOrder/OrderSortTableData", // Controller/View
                    data: {
                        sortOrder: sortOrder
                    }
                }).done(function (data) {
                    $("#tableData").html(data)
                });
        }


        //Delete Confirmation Order
        var orderID;
        function openDeleteConfirmationModal(orderID) {
            this.orderID = orderID
        }

        function deleteConfirmed() {
            $.ajax(
                {
                    type: "POST", //HTTP POST Method
                    url: "/AdminOrder/DeleteConfirmed", // Controller/View
                    data: {
                        orderID: this.orderID,
                    },
                }).done(function (data) {
                    $("#tableData").html(data)
                    var myModalEl = document.getElementById('deleteConfirmationModal')
                    var modal = bootstrap.Modal.getInstance(myModalEl) // Returns a Bootstrap modal instance
                    modal.hide();
                });
        }
    </script>

    <script src="~/lib/js/vue.js"></script>
    <script>
        Vue.component('filter-badge', {
            props: {
                filter: Object
            },
            template: `
            <button v-on:click="onDelete()" class="btn badge badge-filter rounded-pill tooltip-badge">
                {{filter.category}}_{{filter.value}} <i class="far fa-times-circle" style="font-size:11px"></i>
                <span class="tooltip-badgetext">Remove Filter</span>
            </button>`,
            methods: {
                onDelete() {
                    this.$emit('delete-filter', this.filter.id);
                }
            }
        })

        var app = new Vue({
            el: '#vueEl',
            data: {
                searchPlaceholder: "Search",
                searchValue: "",
                filters: [],
                categoryItems: [
                    {
                        id: 0,
                        name: "Email",
                        value: "Email",
                    },
                    {
                        id: 1,
                        name: "First Name",
                        value: "FirstName",
                    },
                    {
                        id: 2,
                        name: "Last Name",
                        value: "LastName",
                    },
                    {
                        id: 3,
                        name: "Order Status",
                        value: "Status",
                    },
                ],
                categorySelected: {
                    id: 0,
                    name: "Email",
                    value: "Email",
                },
            },
            methods: {
                deleteFilter: function (id) {
                    for (i = 0; i < this.filters.length; i++) {
                        if (this.filters[i].id == id) {
                            this.filters.splice(i, 1);
                            break;
                        }
                    }

                    this.removeFilterResult();
                },
                changeCategory: function (id) {
                    this.categorySelected = this.categoryItems[id];
                },
                generateFilterResult: function () {
                    //prevent duplication and empty value
                    if (this.searchValue == "" ||
                        this.filters.some(
                            filterX => (filterX.value.toLowerCase() == this.searchValue.toLowerCase()) &&
                                filterX.category == this.categorySelected.value)
                        )
                        return;

                    this.filters.push({
                        id: this.filters.length,
                        value: this.searchValue,
                        category: this.categorySelected.value,
                    })

                    $.ajax(
                        {
                            type: "POST", //HTTP POST Method
                            url: "/AdminOrder/OrderFilterTableData", // Controller/View
                            data: {
                                filters: this.searchValue,
                                category: this.categorySelected.value
                            }
                        }).done(function (data) {
                            $("#tableData").html(data)
                            app.updatePagination();
                        });

                    this.searchValue = "";
                },
                removeFilterResult:function() {
                    var items = JSON.stringify(this.filters);
                    //console.log(items)

                    $.ajax(
                        {
                            type: "POST", //HTTP POST Method
                            url: "/AdminOrder/OrderRemoveFilterTableData", // Controller/View
                            contentType: 'application/json',
                            dataType: "json",
                            data: items,
                            success: function (data) {
                                //can't get data back if passing partial view, have to do 2nd ajax call
                                $.ajax(
                                    {
                                        type: "POST", //HTTP GET Method
                                        url: "/AdminOrder/RefreshOrderTableIndex", // Controller/View
                                        data: {
                                        }
                                    }).done(function (data) {
                                        console.log(data)
                                        $("#tableData").html(data)
                                        app.updatePagination();
                                    });
                            }
                        });
                },
                updatePagination() {
                    //reset to first page
                    //updatePaginationStyle(0)
                    currentPage = 0;

                    $.ajax(
                        {
                            type: "POST", //HTTP POST Method
                            url: "/AdminOrder/UpdatePagination", // Controller/View
                            data: {
                            }
                        }).done(function (data) {
                            $("#pagination").html(data)
                        });
                }
            },
        })
    </script>
}